"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
var _renderer = _interopRequireDefault(require("../../../core/renderer"));
var _common = require("../../../core/utils/common");
var _extend = require("../../../core/utils/extend");
var _type = require("../../../core/utils/type");
var _context_menu = _interopRequireDefault(require("../../../ui/context_menu"));
var _widget = _interopRequireDefault(require("../../core/widget/widget"));
var _uiFile_manager = require("../../ui/file_manager/ui.file_manager.common");
function _interopRequireDefault(e) { return e && e.__esModule ? e : { default: e }; }
const FILEMANAGER_CONTEXT_MEMU_CLASS = 'dx-filemanager-context-menu';
const DEFAULT_CONTEXT_MENU_ITEMS = {
  create: {},
  upload: {},
  download: {},
  rename: {},
  move: {},
  copy: {},
  delete: {},
  refresh: {
    beginGroup: true
  }
};
const DEFAULT_ITEM_ALLOWED_PROPERTIES = ['beginGroup', 'closeMenuOnClick', 'disabled', 'icon', 'selectable', 'selected', 'text', 'visible'];
class FileManagerContextMenu extends _widget.default {
  _initMarkup() {
    this._initActions();
    this._isVisible = false;
    const $menu = (0, _renderer.default)('<div>').appendTo(this.$element());
    this._contextMenu = this._createComponent($menu, _context_menu.default, {
      cssClass: FILEMANAGER_CONTEXT_MEMU_CLASS,
      showEvent: '',
      onItemClick: args => this._onContextMenuItemClick(args.itemData.name, args),
      onShowing: e => this._onContextMenuShowing(e),
      onShown: () => this._onContextMenuShown(),
      onHidden: () => this._onContextMenuHidden()
    });
    super._initMarkup();
  }
  showAt(fileItems, element, event, target) {
    var _this$_contextMenu, _this$_contextMenu2;
    const {
      itemData,
      itemElement,
      isActionButton = false
    } = target;
    if (this._isVisible) {
      this._onContextMenuHidden();
    }
    this._menuShowingContext = {
      targetElement: itemElement,
      itemData,
      fileItems,
      event,
      isActionButton
    };
    const position = {
      of: element,
      // @ts-expect-error ts-error
      at: 'top left',
      // @ts-expect-error ts-error
      my: 'top left',
      offset: ''
    };
    if (event) {
      position.offset = `${event.offsetX} ${event.offsetY}`;
    } else {
      position.my = 'left top';
      position.at = 'left bottom';
      position.boundaryOffset = '1';
    }
    (_this$_contextMenu = this._contextMenu) === null || _this$_contextMenu === void 0 || _this$_contextMenu.option({
      target: element,
      position
    });
    // eslint-disable-next-line @typescript-eslint/no-floating-promises
    (_this$_contextMenu2 = this._contextMenu) === null || _this$_contextMenu2 === void 0 || _this$_contextMenu2.show();
  }
  createContextMenuItems(fileItems, contextMenuItems, targetFileItem) {
    this._targetFileItems = fileItems;
    this._targetFileItem = (0, _type.isDefined)(targetFileItem) ? targetFileItem : fileItems === null || fileItems === void 0 ? void 0 : fileItems[0];
    const result = [];
    const itemArray = contextMenuItems || this.option('items');
    itemArray.forEach(srcItem => {
      const commandName = (0, _type.isString)(srcItem) ? srcItem : srcItem.name;
      const item = this._configureItemByCommandName(commandName, srcItem, fileItems, this._targetFileItem);
      if (this._isContextMenuItemAvailable(item, fileItems)) {
        result.push(item);
      }
    });
    return result;
  }
  _isContextMenuItemAvailable(menuItem, fileItems) {
    var _this$_commandManager;
    if (!this._isDefaultItem(menuItem.name) || !menuItem._autoHide) {
      return (0, _common.ensureDefined)(menuItem.visible, true);
    }
    if (this._isIsolatedCreationItemCommand(menuItem.name) && fileItems !== null && fileItems !== void 0 && fileItems.length) {
      return false;
    }
    return (_this$_commandManager = this._commandManager) === null || _this$_commandManager === void 0 ? void 0 : _this$_commandManager.isCommandAvailable(menuItem.name, fileItems);
  }
  _isIsolatedCreationItemCommand(commandName) {
    const {
      isolateCreationItemCommands
    } = this.option();
    return (commandName === 'create' || commandName === 'upload') && isolateCreationItemCommands;
  }
  _isDefaultItem(commandName) {
    return !!DEFAULT_CONTEXT_MENU_ITEMS[commandName];
  }
  // eslint-disable-next-line @typescript-eslint/explicit-function-return-type
  _configureItemByCommandName(commandName, item, fileItems, targetFileItem) {
    if (!this._isDefaultItem(commandName)) {
      const res = (0, _extend.extend)(true, {}, item);
      res.originalItemData = item;
      this._addItemClickHandler(commandName, res);
      if (Array.isArray(item.items)) {
        res.items = this.createContextMenuItems(fileItems, item.items, targetFileItem);
      }
      // eslint-disable-next-line @typescript-eslint/no-unsafe-return
      return res;
    }
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    const result = this._createMenuItemByCommandName(commandName);
    const defaultConfig = DEFAULT_CONTEXT_MENU_ITEMS[commandName];
    (0, _extend.extend)(result, defaultConfig);
    result.originalItemData = item;
    (0, _uiFile_manager.extendAttributes)(result, item, DEFAULT_ITEM_ALLOWED_PROPERTIES);
    if (!(0, _type.isDefined)(result.visible)) {
      result._autoHide = true;
    }
    if (commandName && !result.name) {
      (0, _extend.extend)(result, {
        name: commandName
      });
    }
    // eslint-disable-next-line @typescript-eslint/no-unsafe-return
    return result;
  }
  _createMenuItemByCommandName(commandName) {
    var _this$_commandManager2;
    const {
      text,
      icon
    } = ((_this$_commandManager2 = this._commandManager) === null || _this$_commandManager2 === void 0 ? void 0 : _this$_commandManager2.getCommandByName(commandName)) ?? {};
    const menuItem = {
      name: commandName,
      text,
      icon
    };
    this._addItemClickHandler(commandName, menuItem);
    return menuItem;
  }
  _addItemClickHandler(commandName, contextMenuItem) {
    contextMenuItem.onItemClick = args => this._onContextMenuItemClick(commandName, args);
  }
  _onContextMenuItemClick(commandName, args) {
    var _this$_targetFileItem, _this$_actions, _this$_actions$onItem;
    const changedArgs = (0, _extend.extend)(true, {}, args);
    changedArgs.itemData = args.itemData.originalItemData;
    // @ts-expect-error ts-error
    changedArgs.fileSystemItem = (_this$_targetFileItem = this._targetFileItem) === null || _this$_targetFileItem === void 0 ? void 0 : _this$_targetFileItem.fileItem;
    const {
      viewArea
    } = this.option();
    changedArgs.viewArea = viewArea;
    (_this$_actions = this._actions) === null || _this$_actions === void 0 || (_this$_actions$onItem = _this$_actions.onItemClick) === null || _this$_actions$onItem === void 0 || _this$_actions$onItem.call(_this$_actions, changedArgs);
    if (this._isDefaultItem(commandName)) {
      var _this$_commandManager3;
      const targetFileItems = this._isIsolatedCreationItemCommand(commandName) ? null : this._targetFileItems;
      (_this$_commandManager3 = this._commandManager) === null || _this$_commandManager3 === void 0 || _this$_commandManager3.executeCommand(commandName, targetFileItems);
    }
  }
  _initActions() {
    this._actions = {
      onContextMenuHidden: this._createActionByOption('onContextMenuHidden'),
      onContextMenuShowing: this._createActionByOption('onContextMenuShowing'),
      onItemClick: this._createActionByOption('onItemClick')
    };
  }
  _onContextMenuShowing(e) {
    var _this$_actions2, _this$_actions2$onCon;
    if (this._isVisible) {
      this._onContextMenuHidden(true);
    }
    // eslint-disable-next-line no-param-reassign
    e = (0, _extend.extend)(e, this._menuShowingContext, {
      options: this.option(),
      cancel: false
    });
    (_this$_actions2 = this._actions) === null || _this$_actions2 === void 0 || (_this$_actions2$onCon = _this$_actions2.onContextMenuShowing) === null || _this$_actions2$onCon === void 0 || _this$_actions2$onCon.call(_this$_actions2, e);
    if (!e.cancel) {
      var _this$_contextMenu3;
      const items = this.createContextMenuItems(this._menuShowingContext.fileItems, null, this._menuShowingContext.fileSystemItem);
      (_this$_contextMenu3 = this._contextMenu) === null || _this$_contextMenu3 === void 0 || _this$_contextMenu3.option('dataSource', items);
    }
  }
  tryUpdateVisibleContextMenu() {
    if (this._isVisible) {
      var _this$_contextMenu4;
      const items = this.createContextMenuItems(this._targetFileItems);
      (_this$_contextMenu4 = this._contextMenu) === null || _this$_contextMenu4 === void 0 || _this$_contextMenu4.option('dataSource', items);
    }
  }
  _onContextMenuShown() {
    this._isVisible = true;
  }
  _onContextMenuHidden(preserveContext) {
    var _this$_contextMenu5;
    this._isVisible = false;
    if (!preserveContext) {
      this._menuShowingContext = {};
    }
    (_this$_contextMenu5 = this._contextMenu) === null || _this$_contextMenu5 === void 0 || _this$_contextMenu5.option('visible', false);
    this._raiseContextMenuHidden();
  }
  _raiseContextMenuHidden() {
    var _this$_actions3, _this$_actions3$onCon;
    (_this$_actions3 = this._actions) === null || _this$_actions3 === void 0 || (_this$_actions3$onCon = _this$_actions3.onContextMenuHidden) === null || _this$_actions3$onCon === void 0 || _this$_actions3$onCon.call(_this$_actions3);
  }
  _getDefaultOptions() {
    return Object.assign({}, super._getDefaultOptions(), {
      commandManager: undefined,
      onContextMenuHidden: undefined,
      onItemClick: undefined
    });
  }
  _optionChanged(args) {
    const {
      name
    } = args;
    switch (name) {
      case 'commandManager':
        this.repaint();
        break;
      case 'items':
        this.tryUpdateVisibleContextMenu();
        break;
      case 'onItemClick':
      case 'onContextMenuShowing':
      case 'onContextMenuHidden':
        this._actions[name] = this._createActionByOption(name);
        break;
      default:
        super._optionChanged(args);
    }
  }
  get _commandManager() {
    const {
      commandManager
    } = this.option();
    return commandManager;
  }
}
var _default = exports.default = FileManagerContextMenu;